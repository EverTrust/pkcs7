package pkcs7

import (
	"bytes"
	"encoding/asn1"
	"encoding/base64"
	"encoding/pem"
	"fmt"
	"strings"
	"testing"
)

func TestBer2Der(t *testing.T) {
	// indefinite length fixture
	ber := []byte{0x30, 0x80, 0x02, 0x01, 0x01, 0x00, 0x00}
	expected := []byte{0x30, 0x03, 0x02, 0x01, 0x01}
	der, err := ber2der(ber)
	if err != nil {
		t.Fatalf("ber2der failed with error: %v", err)
	}
	if !bytes.Equal(der, expected) {
		t.Errorf("ber2der result did not match.\n\tExpected: % X\n\tActual: % X", expected, der)
	}

	if der2, err := ber2der(der); err != nil {
		t.Errorf("ber2der on DER bytes failed with error: %v", err)
	} else {
		if !bytes.Equal(der, der2) {
			t.Error("ber2der is not idempotent")
		}
	}
	var thing struct {
		Number int
	}
	rest, err := asn1.Unmarshal(der, &thing)
	if err != nil {
		t.Errorf("Cannot parse resulting DER because: %v", err)
	} else if len(rest) > 0 {
		t.Errorf("Resulting DER has trailing data: % X", rest)
	}
}

func TestBer2Der_Negatives(t *testing.T) {
	fixtures := []struct {
		Input         []byte
		ErrorContains string
	}{
		{[]byte{0x30, 0x85}, "tag length too long"},
		{[]byte{0x30, 0x84, 0x80, 0x0, 0x0, 0x0}, "length is negative"},
		{[]byte{0x30, 0x82, 0x0, 0x1}, "length has leading zero"},
		{[]byte{0x30, 0x80, 0x1, 0x2, 0x1, 0x2}, "Invalid BER format"},
		{[]byte{0x30, 0x80, 0x1, 0x2}, "BER tag length is more than available data"},
		{[]byte{0x30, 0x03, 0x01, 0x02}, "length is more than available data"},
		{[]byte{0x30}, "end of ber data reached"},
	}

	for _, fixture := range fixtures {
		_, err := ber2der(fixture.Input)
		if err == nil {
			t.Errorf("No error thrown. Expected: %s", fixture.ErrorContains)
		}
		if !strings.Contains(err.Error(), fixture.ErrorContains) {
			t.Errorf("Unexpected error thrown.\n\tExpected: /%s/\n\tActual: %s", fixture.ErrorContains, err.Error())
		}
	}
}

func TestBer2Der_NestedMultipleIndefinite(t *testing.T) {
	// indefinite length fixture
	ber := []byte{0x30, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x00, 0x00, 0x30, 0x80, 0x02, 0x01, 0x02, 0x00, 0x00, 0x00, 0x00}
	expected := []byte{0x30, 0x0A, 0x30, 0x03, 0x02, 0x01, 0x01, 0x30, 0x03, 0x02, 0x01, 0x02}

	der, err := ber2der(ber)
	if err != nil {
		t.Fatalf("ber2der failed with error: %v", err)
	}
	if !bytes.Equal(der, expected) {
		t.Errorf("ber2der result did not match.\n\tExpected: % X\n\tActual: % X", expected, der)
	}

	if der2, err := ber2der(der); err != nil {
		t.Errorf("ber2der on DER bytes failed with error: %v", err)
	} else {
		if !bytes.Equal(der, der2) {
			t.Error("ber2der is not idempotent")
		}
	}
	var thing struct {
		Nest1 struct {
			Number int
		}
		Nest2 struct {
			Number int
		}
	}
	rest, err := asn1.Unmarshal(der, &thing)
	if err != nil {
		t.Errorf("Cannot parse resulting DER because: %v", err)
	} else if len(rest) > 0 {
		t.Errorf("Resulting DER has trailing data: % X", rest)
	}
}

func TestVerifyIndefiniteLengthBer(t *testing.T) {
	decoded := mustDecodePEM([]byte(testPKCS7))

	_, err := ber2der(decoded)
	if err != nil {
		t.Errorf("cannot parse indefinite length ber: %v", err)
	}
}

func TestBCVerifyLongLengthBer(t *testing.T) {
	cms := "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"
	cmsbytes, err := base64.StdEncoding.DecodeString(cms)
	if err != nil {
		t.Errorf("error decoding base64: " + err.Error())
	}
	p7, err := Parse(cmsbytes)
	if err != nil {
		t.Errorf("error parsing PKCS#7: " + err.Error())
	}
	_, err = Parse(p7.Content)
	if err != nil {
		t.Errorf("error parsing PKCS#7 content: " + err.Error())
	}
}

func mustDecodePEM(data []byte) []byte {
	var block *pem.Block
	block, rest := pem.Decode(data)
	if len(rest) != 0 {
		panic(fmt.Errorf("unexpected remaining PEM block during decode"))
	}
	return block.Bytes
}

const testPKCS7 = `
-----BEGIN PKCS7-----
MIAGCSqGSIb3DQEHAqCAMIACAQExDzANBglghkgBZQMEAgEFADCABgkqhkiG9w0B
BwGggCSABIIDfXsiQWdlbnRBY3Rpb25PdmVycmlkZXMiOnsiQWdlbnRPdmVycmlk
ZXMiOnsiRmlsZUV4aXN0c0JlaGF2aW9yIjoiT1ZFUldSSVRFIn19LCJBcHBsaWNh
dGlvbklkIjoiZTA0NDIzZTQtN2E2Ny00ZjljLWIyOTEtOTllNjNjMWMyMTU4Iiwi
QXBwbGljYXRpb25OYW1lIjoibWthbmlhLXhyZF9zYW0uY2R3c19lY2hvc2VydmVy
IiwiRGVwbG95bWVudENyZWF0b3IiOiJ1c2VyIiwiRGVwbG95bWVudEdyb3VwSWQi
OiJmYWI5MjEwZi1mNmM3LTQyODUtYWEyZC03Mzc2MGQ4ODE3NmEiLCJEZXBsb3lt
ZW50R3JvdXBOYW1lIjoibWthbmlhLXhyZF9zYW0uY2R3c19lY2hvc2VydmVyX2Rn
IiwiRGVwbG95bWVudElkIjoiZC1UREUxVTNXREEiLCJEZXBsb3ltZW50VHlwZSI6
IklOX1BMQUNFIiwiR2l0SHViQWNjZXNzVG9rZW4iOm51bGwsIkluc3RhbmNlR3Jv
dXBJZCI6ImZhYjkyMTBmLWY2YzctNDI4NS1hYTJkLTczNzYwZDg4MTc2YSIsIlJl
dmlzaW9uIjp7IkFwcFNwZWNDb250ZW50IjpudWxsLCJDb2RlQ29tbWl0UmV2aXNp
b24iOm51bGwsIkdpdEh1YlJldmlzaW9uIjpudWxsLCJHaXRSZXZpc2lvbiI6bnVs
bCwiUmV2aXNpb25UeXBlIjoiUzMiLCJTM1JldmlzaW9uIjp7IkJ1Y2tldCI6Im1r
YW5pYS1jZHdzLWRlcGxveS1idWNrZXQiLCJCdW5kbGVUeXBlIjoiemlwIiwiRVRh
ZyI6bnVsbCwiS2V5IjoieHJkOjpzYW0uY2R3czo6ZWNob3NlcnZlcjo6MTo6Lnpp
cCIsIlZlcnNpb24iOm51bGx9fSwiUzNSZXZpc2lvbiI6eyJCdWNrZXQiOiJta2Fu
aWEtY2R3cy1kZXBsb3ktYnVja2V0IiwiQnVuZGxlVHlwZSI6InppcCIsIkVUYWci
Om51bGwsIktleSI6InhyZDo6c2FtLmNkd3M6OmVjaG9zZXJ2ZXI6OjE6Oi56aXAi
LCJWZXJzaW9uIjpudWxsfSwiVGFyZ2V0UmV2aXNpb24iOm51bGx9AAAAAAAAoIAw
ggWbMIIEg6ADAgECAhAGrjFMK45t2jcNHtjY1DjEMA0GCSqGSIb3DQEBCwUAMEYx
CzAJBgNVBAYTAlVTMQ8wDQYDVQQKEwZBbWF6b24xFTATBgNVBAsTDFNlcnZlciBD
QSAxQjEPMA0GA1UEAxMGQW1hem9uMB4XDTIwMTExMjAwMDAwMFoXDTIxMTAxNTIz
NTk1OVowNDEyMDAGA1UEAxMpY29kZWRlcGxveS1zaWduZXItdXMtZWFzdC0yLmFt
YXpvbmF3cy5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDit4f+
I4BSv4rBV/8bJ+f4KqBwTCt9iJeau/r9liQfMgj/C1M2E+aa++u8BtY/LQstB44v
v6KqcaiOyWpkD9OsUty9qb4eNTPF2Y4jpNsi/Hfw0phsd9gLun2foppILmL4lZIG
lBhTeEwv6qV4KbyXOG9abHOX32+jVFtM1rbzHNFvz90ysfZp16TBAi7IRKEZeXvd
MvlJJMAJtAoblxiDIS3A1csY1G4XHYET8xIoCop3mqEZEtAxUUP2epdXXdhD2U0G
7alSRS54o91QW1Dp3A13lu1A1nds9CkWlPkDTpKSUG/qN5y5+6dCCGaydgL5krMs
R79bCrR1sEKm5hi1AgMBAAGjggKVMIICkTAfBgNVHSMEGDAWgBRZpGYGUqB7lZI8
o5QHJ5Z0W/k90DAdBgNVHQ4EFgQUPF5qTbnTDYhmp7tGmmL/jTmLoHMwNAYDVR0R
BC0wK4IpY29kZWRlcGxveS1zaWduZXItdXMtZWFzdC0yLmFtYXpvbmF3cy5jb20w
DgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjA7
BgNVHR8ENDAyMDCgLqAshipodHRwOi8vY3JsLnNjYTFiLmFtYXpvbnRydXN0LmNv
bS9zY2ExYi5jcmwwIAYDVR0gBBkwFzALBglghkgBhv1sAQIwCAYGZ4EMAQIBMHUG
CCsGAQUFBwEBBGkwZzAtBggrBgEFBQcwAYYhaHR0cDovL29jc3Auc2NhMWIuYW1h
em9udHJ1c3QuY29tMDYGCCsGAQUFBzAChipodHRwOi8vY3J0LnNjYTFiLmFtYXpv
bnRydXN0LmNvbS9zY2ExYi5jcnQwDAYDVR0TAQH/BAIwADCCAQQGCisGAQQB1nkC
BAIEgfUEgfIA8AB2APZclC/RdzAiFFQYCDCUVo7jTRMZM7/fDC8gC8xO8WTjAAAB
dboejIcAAAQDAEcwRQIgeqoKXbST17TCEzM1BMWx/jjyVQVBIN3LG17U4OaV364C
IQDPUSJZhJm7uqGea6+VwqeDe/vGuGSuJzkDwTIOeIXPaAB2AFzcQ5L+5qtFRLFe
mtRW5hA3+9X6R9yhc5SyXub2xw7KAAABdboejNQAAAQDAEcwRQIgEKIAwwhjUcq2
iwzBAagdy+fTiKnBY1Yjf6wOeRpwXfMCIQC8wM3nxiWrGgIpdzzgDvFhZZTV3N81
JWcYAu+srIVOhTANBgkqhkiG9w0BAQsFAAOCAQEAer9kml53XFy4ZSVzCbdsIFYP
Ohu7LDf5iffHBVZFnGOEVOmiPYYkNwi9R6EHIYaAs7G7GGLCp/6tdc+G4eF1j6wB
IkmXZcxMTxk/87R+S+36yDLg1GBZvqttLfexj0TRVAfVLJc7FjLXAW2+wi7YyNe8
X17lWBwHxa1r5KgweJshGzYVUsgMTSx0aJ+93ZnqplBp9x+9DSQNqqNlBgxFANxs
ux+dfpduyLd8VLqtlECGC07tYE4mBaAjMiNjCZRWMp8ya/Z6J/bJZ27IDGA4dXzm
l9NNnlbuUDAenAByUqE+0b78J6EmmdAVf+N8siriMg02FdP3lAXJLE8tDeZp8AAA
MYICIDCCAhwCAQEwWjBGMQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRUw
EwYDVQQLEwxTZXJ2ZXIgQ0EgMUIxDzANBgNVBAMTBkFtYXpvbgIQBq4xTCuObdo3
DR7Y2NQ4xDANBglghkgBZQMEAgEFAKCBmDAYBgkqhkiG9w0BCQMxCwYJKoZIhvcN
AQcBMBwGCSqGSIb3DQEJBTEPFw0yMTA2MjQxOTU1MzFaMC0GCSqGSIb3DQEJNDEg
MB4wDQYJYIZIAWUDBAIBBQChDQYJKoZIhvcNAQELBQAwLwYJKoZIhvcNAQkEMSIE
IP7gMuT2H0/AhgPgj3Eo0NWCIdQOBjJO18coNKIaOnJYMA0GCSqGSIb3DQEBCwUA
BIIBAJX+e87q0YvRon9/ENTvE0FoYMzYblID2Reek6L217ZlZ6pUuRsc4ghhJ5Yh
WZeOCaLwi4mrnQ5/+DGKkJ4a/w5sqFTwtJIGIIAuDCn/uDm8kIDUVkbeznSOLoPA
67cxiqgIdqZ5pqUoid2YsDj20owrGDG4wUF6ZvhM9g/5va3CAhxqvTE2HwjhHTfz
Cgl8Nlvalz7YxXEf2clFEiEVa1fVaGMl9pCyedAmTfd6hoivcpAsopvXfVaaaR2y
iuZidpUfFhSk+Ls7TU/kB74ckfUGj5q/5HcKJgb/S+FYUV7eu0ewzTyW1uRl/d0U
Tb7e7EjgDGJsjOTMdTrMfv8ho8kAAAAAAAA=
-----END PKCS7-----
`
